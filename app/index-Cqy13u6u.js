var P=Object.defineProperty;var R=(p,e,r)=>e in p?P(p,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):p[e]=r;var _=(p,e,r)=>R(p,typeof e!="symbol"?e+"":e,r);import{a as f,j as l}from"./vendor-react-08UYt03A.js";import{c as S}from"./vendor-react-dom-C8YMDE6l.js";import{F as I}from"./vendor-file-saver-XujEUW7e.js";import{J as z}from"./vendor-jszip-DA_35h81.js";import{b as O}from"./vendor-buffer-Be-il6ZS.js";import{P as F}from"./vendor-pcb-stackup-CujRJLBJ.js";import{p as D}from"./vendor-process-Dx8qOcfY.js";import{W as A,S as B,P as M,O as N,A as T,a as U,T as G,B as W,M as j,b as $,c as H}from"./vendor-three-Ckw31WsC.js";import"./vendor-scheduler-BF-YhwgH.js";import"./vendor-@tracespace-_ibhTgpc.js";import"./vendor-base64-js-DRz5BQNA.js";import"./vendor-ieee754-vIlwft-x.js";import"./vendor-xtend-VQg9yHl6.js";import"./vendor-run-parallel-CD1_Jmin.js";import"./vendor-queue-microtask-k88_duEE.js";import"./vendor-run-waterfall-caUdQ7AG.js";import"./vendor-gerber-to-svg-DFKxK_0l.js";import"./vendor-gerber-parser-ClboYFFq.js";import"./vendor-lodash.isfinite-1y0ymm8B.js";import"./vendor-string_decoder-DZPR7MxD.js";import"./vendor-safe-buffer-DcNHIamD.js";import"./vendor-inherits-BICa84dG.js";import"./vendor-readable-stream-Bo7DI6DN.js";import"./vendor-events-DQ172AOg.js";import"./vendor-util-deprecate-B2OF2CkE.js";import"./vendor-lodash.padstart-N4jo84Bx.js";import"./vendor-lodash.padend-C_7kNAQY.js";import"./vendor-gerber-plotter-BPlChmpN.js";import"./vendor-lodash.fill-DjFi-7ML.js";import"./vendor-lodash.isfunction-DOfGYLuz.js";import"./vendor-xml-element-string-4eagscF3.js";import"./vendor-escape-html-CnGJ826T.js";import"./vendor-pcb-stackup-core-DLlTdNNm.js";import"./vendor-whats-that-gerber-Drp5jgFj.js";import"./vendor-viewbox-IwQ9f3jH.js";import"./vendor-color-string-DcuAIlqQ.js";import"./vendor-color-name-Dju3oUBS.js";import"./vendor-simple-swizzle-3gX0Onlb.js";import"./vendor-is-arrayish-DyGeW-O8.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();const L={base64ToBlob(p){const e=atob(p.split(",")[1]),r=e.length,a=new Uint8Array(r);for(let o=0;o<r;o++)a[o]=e.charCodeAt(o);return new Blob([a])}};window.process=D;const q=p=>{const[e,r]=f.useState(),[a,o]=f.useState(1);f.useEffect(()=>{c()},[p]);const c=async()=>{if(p===void 0)return;console.log({gerberFiles:p});const n=d(p);console.log({layers:n});const t=await F(n);console.log({pcb:t});const s=await m(t.top),i=await m(t.bottom);console.log({top:s,bottom:i}),r({top:s,bottom:i})},d=n=>{let t=[];for(const s of Object.keys(n)){const{type:i,side:b}=h(s);t=[...t,{type:i,side:b,gerber:O.Buffer.from(n[s]),filename:s}]}return t},h=n=>{let t=null,s=null;const i=n.toLowerCase().split(/_|-|\./);switch(i[i.length-1]){case"gtl":return{type:"copper",side:"top"};case"gto":return{type:"silkscreen",side:"top"};case"gtp":return{type:"solderpaste",side:"top"};case"gts":return{type:"soldermask",side:"top"};case"gbl":return{type:"copper",side:"bottom"};case"gbo":return{type:"silkscreen",side:"bottom"};case"gbp":return{type:"solderpaste",side:"bottom"};case"gbs":return{type:"soldermask",side:"bottom"};case"gko":return{type:"outline",side:"all"};case"drl":return{type:"drill",side:"all"}}return i.find(u=>u.includes("edge"))||i.find(u=>u.includes("outline"))?{type:"outline",side:"all"}:(i.includes("sm")||i.find(u=>u.includes("mask"))?t="soldermask":i.includes("sp")||i.find(u=>u.includes("paste"))?t="solderpaste":i.includes("ss")||i.find(u=>u.includes("silk"))?t="silkscreen":i.includes("cu")&&(t="copper"),i.find(u=>u.startsWith("in"))?s="inner":i.includes("f")||i.find(u=>u.includes("top"))?s="top":(i.includes("b")||i.find(u=>u.includes("bottom")))&&(s="bottom"),s=="inner"&&!t&&(t="copper"),{type:t,side:s})},m=n=>(console.log({model:n}),new Promise(t=>{const{width:s,height:i}=g(n),b=new Blob([n.svg],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(b),y=new Image;y.onload=function(){const v=document.createElement("canvas");v.width=s,v.height=i,v.getContext("2d").drawImage(y,0,0,s,i);const k=v.toDataURL("image/png");t(k),URL.revokeObjectURL(u)},y.src=u})),g=n=>{const t=n.width/n.height;o(t);const s=512,i=n.height=512/t;return{width:s,height:i}};return{gerberImg:e,ratio:a}},J=["gtl","gto","gtp","gts","gbl","gbo","gbp","gbs","gko","drl"],V=["a","b","c","d","e"],X=()=>{const[p,e]=f.useState(!1),[r,a]=f.useState();f.useEffect(()=>{o().then(()=>{e(!0)})},[]);const o=async()=>{const n=c();n!==null&&await d(n)},c=()=>{const n=window.location.search,s=new URLSearchParams(n).get("gerber");return console.log({gerber:s}),s},d=async n=>{const s=await(await fetch(n)).arrayBuffer(),i=await h(s);await m(i)},h=async n=>{const s=await new z().loadAsync(n);let i=[];for(const b of Object.values(s.files))i=[...i,b];return i},m=async n=>{let t={};for(const s of n){const i=s.name,b=i.toLowerCase().split(/_|-|\./),u=b[b.length-1];if(J.includes(u)){const y=await s.async("uint8array");t[i]=y}}a(t)};return{gerberFiles:r,setLink:d,unzipFile:async n=>{const t=await n.arrayBuffer(),s=await h(t);await m(s)},mounted:p}},x={light:16777215,specular:13421772,pcbColor:2445317,indentStart:"#E4E4E7",indentEnd:"#A1A1AA"};class Z{constructor(e){_(this,"renderer",new A);_(this,"scene",new B);_(this,"camera");_(this,"mesh");_(this,"id");_(this,"rotating",!0);_(this,"animate",()=>{this.initPosition();const e=requestAnimationFrame(this.animate);return this.renderer.render(this.scene,this.camera),e});this.init(e),this.setCamera(e),this.setLight(),this.id=this.animate()}get getRendererDom(){return this.renderer.domElement}dispose(){cancelAnimationFrame(this.id)}init({width:e,height:r}){this.renderer.setSize(e,r),this.scene.background=this.getBackground()}setCamera({width:e,height:r}){this.camera=new M(75,e/r,.1,1e3),this.camera.position.z=5}setOrbitControl(e){new N(this.camera,e)}setLight(){const e=new T(x.light,1);this.scene.add(e);const r=new U(x.light,.3);this.camera.add(r),this.scene.add(this.camera)}async makeObj(e,r){if(r===void 0)return;const a=new G,o=await a.loadAsync(r.top),c=await a.loadAsync(r.bottom);c.rotation=Math.PI,c.center.set(.5,.5);const d={shininess:80,specular:x.specular},h=new W(3,.05,3/e),m=new j({...d,color:x.pcbColor}),g=new j({...d,map:o,transparent:!0}),n=new j({...d,map:c,transparent:!0});this.mesh=new $(h,[m,m,g,n,m,m]),this.scene.add(this.mesh)}getBackground(){const e=document.createElement("canvas"),r=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const a=r.createLinearGradient(0,0,0,e.height);a.addColorStop(0,x.indentStart),a.addColorStop(.4,x.indentEnd),r.fillStyle=a,r.fillRect(0,0,e.width,e.height);const o=new H(e);return o.needsUpdate=!0,o}setResizeHandler(e){const r=e.clientWidth,a=e.clientHeight;this.renderer.setSize(r,a),this.camera.aspect=r/a,this.camera.updateProjectionMatrix()}initPosition(){this.rotating&&this.mesh&&(this.mesh.rotation.x+=.05,this.mesh.rotation.x>=Math.PI/2&&(this.mesh.rotation.x=Math.PI/2,this.rotating=!1))}}const K=()=>{const{gerberFiles:p,setLink:e,unzipFile:r,mounted:a}=X(),{ratio:o,gerberImg:c}=q(p),[d,h]=f.useState(!0),m=f.useRef(null);return f.useEffect(()=>{let n;const t=()=>{n&&n.setResizeHandler(m.current)};if(c){const s={width:window.innerWidth,height:window.innerHeight};n=new Z(s),n.setOrbitControl(m.current),n.makeObj(o,c),m.current.appendChild(n.getRendererDom),window.onresize=t,h(!1)}return()=>{n==null||n.dispose(),window.onresize=null}},[c]),{ref:m,setLink:e,isLoading:d,hasGerber:a&&p!==void 0,unzipFile:r,onDownloadImg:async()=>{const n=L.base64ToBlob(c.top),t=L.base64ToBlob(c.bottom),s=new z;s.file("pcb_top.png",n),s.file("pcb_bottom.png",t);const i=await s.generateAsync({type:"blob"});console.log({zipFile:i}),I.saveAs(i,"pcb_image.zip")}}},Y="_div_container_6zj0x_1",Q="_div_example_6zj0x_10",E={div_container:Y,div_example:Q},ee=({children:p,onClickExample:e})=>{const r=a=>({img:`/gerber-3d-viewer/example/${a}/image.png`,gerber:`/gerber-3d-viewer/example/${a}/gerber.zip`});return l.jsxs("div",{className:E.div_container,children:[p,l.jsxs("div",{className:E.div_example,children:[l.jsx("h2",{children:"Examples"}),V.map((a,o)=>{const{img:c,gerber:d}=r(a);return l.jsx("img",{src:c,onClick:()=>e(d)},`ex-${o}`)})]})]})},te="_div_github_x2rey_1",ne={div_github:te},se=()=>l.jsxs("div",{className:ne.div_github,children:[l.jsx("a",{href:"https://github.com/devmemory/gerber-3d-viewer",target:"_blank",rel:"noopener noreferrer",children:"ReadMe"}),l.jsx("a",{href:"https://github.com/devmemory/gerber-3d-viewer/issues",target:"_blank",rel:"noopener noreferrer",children:"Issue"})]}),re=["application/x-zip-compressed","application/zip"],oe=({unzipFile:p})=>{const e=f.useRef(null),[r,a]=f.useState(!1),o=t=>{t.preventDefault();const s=t.dataTransfer.files;d(s),n()},c=t=>{const s=t.target.files;s&&d(s)},d=t=>{if(t.length>1){alert("Please drop only one zip file");return}const s=t[0];if(!re.includes(s.type)){alert("Please drop only .zip file");return}p(s)},h=()=>{var t;(t=e.current)==null||t.click()},m=t=>{t.preventDefault()},g=t=>{m(t),r||a(!0)},n=()=>{r&&a(!1)};return{ref:e,onDropFiles:o,onChangeFile:c,onOpenExplorer:h,onClickPrevent:m,onDragEnter:g,onDragLeave:n,isIn:r}},ie="_label_file_19tjc_1",ae="_img_upload_19tjc_26",ce="_icon_hover_19tjc_1",le="_input_path_19tjc_36",pe="_p_info_19tjc_42",de="_btn_move_19tjc_47",w={label_file:ie,in:"_in_19tjc_15",img_upload:ae,icon_hover:ce,input_path:le,p_info:pe,btn_move:de},me=({unzipFile:p})=>{const{ref:e,onChangeFile:r,onDropFiles:a,onOpenExplorer:o,onClickPrevent:c,onDragEnter:d,onDragLeave:h,isIn:m}=oe({unzipFile:p}),[g,n]=f.useState(""),t=()=>{g.startsWith("http")&&g.endsWith(".zip")&&(window.location.href="?gerber="+g)};return l.jsxs(l.Fragment,{children:[l.jsx("h1",{children:"Gerber 3D viewer beta"}),l.jsxs("label",{className:`${w.label_file} ${m?w.in:""}`,onClick:c,onDragOver:d,onDragLeave:h,onDrop:a,children:[l.jsxs("div",{className:w.div_upload_btn,children:["Click here to upload file",l.jsx("img",{className:w.img_upload,width:30,height:30,src:"/gerber-3d-viewer/icon/upload.svg",onClick:o})]}),l.jsx("p",{children:"Or"}),l.jsx("div",{children:"Drag gerber file in box"}),l.jsx("p",{children:"Or"}),l.jsxs("div",{children:["Enter gerber zip url here",l.jsx("input",{className:w.input_path,placeholder:"Enter gerber zip",value:g,onChange:s=>n(s.target.value)}),l.jsx("button",{className:w.btn_move,onClick:t,children:"Move"})]}),l.jsx("p",{className:w.p_info,children:"(Only zip file is supported now)"})]}),l.jsx("input",{ref:e,className:"hidden",type:"file",accept:".zip",onChange:r})]})},ue="_main_12bpp_1",he="_btn_download_12bpp_9",C={main:ue,btn_download:he},ge=()=>{const{isLoading:p,hasGerber:e,setLink:r,ref:a,unzipFile:o,onDownloadImg:c}=K();return l.jsxs(l.Fragment,{children:[l.jsx("div",{className:C.main,ref:a,children:!e&&l.jsx(ee,{onClickExample:r,children:l.jsx(me,{unzipFile:o})})}),e&&l.jsx("button",{className:C.btn_download,onClick:c,children:"Download gerber image"}),l.jsx(se,{})]})};S.createRoot(document.getElementById("root")).render(l.jsx(ge,{}));
