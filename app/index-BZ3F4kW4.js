var k=Object.defineProperty;var R=(l,e,s)=>e in l?k(l,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[e]=s;var _=(l,e,s)=>R(l,typeof e!="symbol"?e+"":e,s);import{a as f,j as p}from"./vendor-react-08UYt03A.js";import{c as S}from"./vendor-react-dom-C8YMDE6l.js";import{F as O}from"./vendor-file-saver-XujEUW7e.js";import{J as z}from"./vendor-jszip-DA_35h81.js";import{b as F}from"./vendor-buffer-Be-il6ZS.js";import{P as I}from"./vendor-pcb-stackup-CujRJLBJ.js";import{p as D}from"./vendor-process-Dx8qOcfY.js";import{W as A,S as B,P as M,O as T,A as N,a as U,T as G,B as W,M as j,b as $,c as H}from"./vendor-three-Ckw31WsC.js";import"./vendor-scheduler-BF-YhwgH.js";import"./vendor-@tracespace-_ibhTgpc.js";import"./vendor-base64-js-DRz5BQNA.js";import"./vendor-ieee754-vIlwft-x.js";import"./vendor-xtend-VQg9yHl6.js";import"./vendor-run-parallel-CD1_Jmin.js";import"./vendor-queue-microtask-k88_duEE.js";import"./vendor-run-waterfall-caUdQ7AG.js";import"./vendor-gerber-to-svg-DFKxK_0l.js";import"./vendor-gerber-parser-ClboYFFq.js";import"./vendor-lodash.isfinite-1y0ymm8B.js";import"./vendor-string_decoder-DZPR7MxD.js";import"./vendor-safe-buffer-DcNHIamD.js";import"./vendor-inherits-BICa84dG.js";import"./vendor-readable-stream-Bo7DI6DN.js";import"./vendor-events-DQ172AOg.js";import"./vendor-util-deprecate-B2OF2CkE.js";import"./vendor-lodash.padstart-N4jo84Bx.js";import"./vendor-lodash.padend-C_7kNAQY.js";import"./vendor-gerber-plotter-BPlChmpN.js";import"./vendor-lodash.fill-DjFi-7ML.js";import"./vendor-lodash.isfunction-DOfGYLuz.js";import"./vendor-xml-element-string-4eagscF3.js";import"./vendor-escape-html-CnGJ826T.js";import"./vendor-pcb-stackup-core-DLlTdNNm.js";import"./vendor-whats-that-gerber-Drp5jgFj.js";import"./vendor-viewbox-IwQ9f3jH.js";import"./vendor-color-string-DcuAIlqQ.js";import"./vendor-color-name-Dju3oUBS.js";import"./vendor-simple-swizzle-3gX0Onlb.js";import"./vendor-is-arrayish-DyGeW-O8.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();const L={base64ToBlob(l){const e=atob(l.split(",")[1]),s=e.length,c=new Uint8Array(s);for(let r=0;r<s;r++)c[r]=e.charCodeAt(r);return new Blob([c])}};window.process=D;const q=l=>{const[e,s]=f.useState(),[c,r]=f.useState(1);f.useEffect(()=>{a()},[l]);const a=async()=>{if(l===void 0)return;console.log({gerberFiles:l});const n=u(l);console.log({layers:n});const t=await I(n);console.log({pcb:t});const o=await d(t.top),i=await d(t.bottom);console.log({top:o,bottom:i}),s({top:o,bottom:i})},u=n=>{let t=[];for(const o of Object.keys(n)){const{type:i,side:b}=h(o);t=[...t,{type:i,side:b,gerber:F.Buffer.from(n[o]),filename:o}]}return t},h=n=>{let t=null,o=null;const i=n.toLowerCase().split(/_|-|\./);switch(i[i.length-1]){case"gtl":return{type:"copper",side:"top"};case"gto":return{type:"silkscreen",side:"top"};case"gtp":return{type:"solderpaste",side:"top"};case"gts":return{type:"soldermask",side:"top"};case"gbl":return{type:"copper",side:"bottom"};case"gbo":return{type:"silkscreen",side:"bottom"};case"gbp":return{type:"solderpaste",side:"bottom"};case"gbs":return{type:"soldermask",side:"bottom"};case"gko":return{type:"outline",side:"all"};case"drl":return{type:"drill",side:"all"}}return i.find(m=>m.includes("edge"))||i.find(m=>m.includes("outline"))?{type:"outline",side:"all"}:(i.includes("sm")||i.find(m=>m.includes("mask"))?t="soldermask":i.includes("sp")||i.find(m=>m.includes("paste"))?t="solderpaste":i.includes("ss")||i.find(m=>m.includes("silk"))?t="silkscreen":i.includes("cu")&&(t="copper"),i.find(m=>m.startsWith("in"))?o="inner":i.includes("f")||i.find(m=>m.includes("top"))?o="top":(i.includes("b")||i.find(m=>m.includes("bottom")))&&(o="bottom"),o=="inner"&&!t&&(t="copper"),{type:t,side:o})},d=n=>(console.log({model:n}),new Promise(t=>{const{width:o,height:i}=g(n),b=new Blob([n.svg],{type:"image/svg+xml;charset=utf-8"}),m=URL.createObjectURL(b),y=new Image;y.onload=function(){const v=document.createElement("canvas");v.width=o,v.height=i,v.getContext("2d").drawImage(y,0,0,o,i);const P=v.toDataURL("image/png");t(P),URL.revokeObjectURL(m)},y.src=m})),g=n=>{const t=n.width/n.height;r(t);const o=512,i=n.height=512/t;return{width:o,height:i}};return{gerberImg:e,ratio:c}},J=["gtl","gto","gtp","gts","gbl","gbo","gbp","gbs","gko","drl"],V=["a","b","c","d","e"],X=()=>{const[l,e]=f.useState(!1),[s,c]=f.useState();f.useEffect(()=>{r().then(()=>{e(!0)})},[]);const r=async()=>{const n=a();n!==null&&await u(n)},a=()=>{const n=window.location.search,o=new URLSearchParams(n).get("gerber");return console.log({gerber:o}),o},u=async n=>{const o=await(await fetch(n)).arrayBuffer(),i=await h(o);await d(i)},h=async n=>{const o=await new z().loadAsync(n);let i=[];for(const b of Object.values(o.files))i=[...i,b];return i},d=async n=>{let t={};for(const o of n){const i=o.name,b=i.toLowerCase().split(/_|-|\./),m=b[b.length-1];if(J.includes(m)){const y=await o.async("uint8array");t[i]=y}}c(t)};return{gerberFiles:s,setLink:u,unzipFile:async n=>{const t=await n.arrayBuffer(),o=await h(t);await d(o)},mounted:l}},x={light:16777215,specular:13421772,pcbColor:2445317,indentStart:"#E4E4E7",indentEnd:"#A1A1AA"};class Z{constructor(e){_(this,"renderer",new A);_(this,"scene",new B);_(this,"camera");_(this,"mesh");_(this,"id");_(this,"rotating",!0);_(this,"animate",()=>{this.initPosition();const e=requestAnimationFrame(this.animate);return this.renderer.render(this.scene,this.camera),e});this.init(e),this.setCamera(e),this.setLight(),this.id=this.animate()}get getRendererDom(){return this.renderer.domElement}dispose(){cancelAnimationFrame(this.id)}init({width:e,height:s}){this.renderer.setSize(e,s),this.scene.background=this.getBackground()}setCamera({width:e,height:s}){this.camera=new M(75,e/s,.1,1e3),this.camera.position.z=5}setOrbitControl(e){new T(this.camera,e)}setLight(){const e=new N(x.light,1);this.scene.add(e);const s=new U(x.light,.3);this.camera.add(s),this.scene.add(this.camera)}async makeObj(e,s){if(s===void 0)return;const c=new G,r=await c.loadAsync(s.top),a=await c.loadAsync(s.bottom);a.rotation=Math.PI,a.center.set(.5,.5);const u={shininess:80,specular:x.specular},h=new W(3,.05,3/e),d=new j({...u,color:x.pcbColor}),g=new j({...u,map:r,transparent:!0}),n=new j({...u,map:a,transparent:!0});this.mesh=new $(h,[d,d,g,n,d,d]),this.scene.add(this.mesh)}getBackground(){const e=document.createElement("canvas"),s=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const c=s.createLinearGradient(0,0,0,e.height);c.addColorStop(0,x.indentStart),c.addColorStop(.4,x.indentEnd),s.fillStyle=c,s.fillRect(0,0,e.width,e.height);const r=new H(e);return r.needsUpdate=!0,r}setResizeHandler(e){const s=e.clientWidth,c=e.clientHeight;this.renderer.setSize(s,c),this.camera.aspect=s/c,this.camera.updateProjectionMatrix()}initPosition(){this.rotating&&this.mesh&&(this.mesh.rotation.x+=.05,this.mesh.rotation.x>=Math.PI/2&&(this.mesh.rotation.x=Math.PI/2,this.rotating=!1))}}const K=()=>{const{gerberFiles:l,setLink:e,unzipFile:s,mounted:c}=X(),{ratio:r,gerberImg:a}=q(l),[u,h]=f.useState(!0),d=f.useRef(null);return f.useEffect(()=>{let n;const t=()=>{n&&n.setResizeHandler(d.current)};if(a){const o={width:window.innerWidth,height:window.innerHeight};n=new Z(o),n.setOrbitControl(d.current),n.makeObj(r,a),d.current.appendChild(n.getRendererDom),window.onresize=t,h(!1)}return()=>{n==null||n.dispose(),window.onresize=null}},[a]),{ref:d,setLink:e,isLoading:u,hasGerber:c&&l!==void 0,unzipFile:s,onDownloadImg:async()=>{const n=L.base64ToBlob(a.top),t=L.base64ToBlob(a.bottom),o=new z;o.file("pcb_top.png",n),o.file("pcb_bottom.png",t);const i=await o.generateAsync({type:"blob"});console.log({zipFile:i}),O.saveAs(i,"pcb_image.zip")}}},Y="_div_container_6zj0x_1",Q="_div_example_6zj0x_10",E={div_container:Y,div_example:Q},ee=({children:l,onClickExample:e})=>p.jsxs("div",{className:E.div_container,children:[l,p.jsxs("div",{className:E.div_example,children:[p.jsx("h2",{children:"Examples"}),V.map((s,c)=>p.jsx("img",{src:`/example/${s}/image.png`,onClick:()=>e(`/example/${s}/gerber.zip`)},`ex-${c}`))]})]}),te=["application/x-zip-compressed","application/zip"],ne=({unzipFile:l})=>{const e=f.useRef(null),[s,c]=f.useState(!1),r=t=>{t.preventDefault();const o=t.dataTransfer.files;u(o),n()},a=t=>{const o=t.target.files;o&&u(o)},u=t=>{if(t.length>1){alert("Please drop only one zip file");return}const o=t[0];if(!te.includes(o.type)){alert("Please drop only .zip file");return}l(o)},h=()=>{var t;(t=e.current)==null||t.click()},d=t=>{t.preventDefault()},g=t=>{d(t),s||c(!0)},n=()=>{s&&c(!1)};return{ref:e,onDropFiles:r,onChangeFile:a,onOpenExplorer:h,onClickPrevent:d,onDragEnter:g,onDragLeave:n,isIn:s}},oe="_label_file_19tjc_1",se="_img_upload_19tjc_26",ie="_icon_hover_19tjc_1",re="_input_path_19tjc_36",ae="_p_info_19tjc_42",ce="_btn_move_19tjc_47",w={label_file:oe,in:"_in_19tjc_15",img_upload:se,icon_hover:ie,input_path:re,p_info:ae,btn_move:ce},le=({unzipFile:l})=>{const{ref:e,onChangeFile:s,onDropFiles:c,onOpenExplorer:r,onClickPrevent:a,onDragEnter:u,onDragLeave:h,isIn:d}=ne({unzipFile:l}),[g,n]=f.useState(""),t=()=>{g.startsWith("http")&&g.endsWith(".zip")&&(window.location.href="?gerber="+g)};return p.jsxs(p.Fragment,{children:[p.jsx("h1",{children:"Welcome to gerber 3D viewer beta version"}),p.jsxs("label",{className:`${w.label_file} ${d?w.in:""}`,onClick:a,onDragOver:u,onDragLeave:h,onDrop:c,children:[p.jsxs("div",{className:w.div_upload_btn,children:["Click here to upload file",p.jsx("img",{className:w.img_upload,width:30,height:30,src:"/icon/upload.svg",onClick:r})]}),p.jsx("p",{children:"Or"}),p.jsx("div",{children:"Drag gerber file in box"}),p.jsx("p",{children:"Or"}),p.jsxs("div",{children:["Enter gerber zip url here",p.jsx("input",{className:w.input_path,placeholder:"Enter gerber zip",value:g,onChange:o=>n(o.target.value)}),p.jsx("button",{className:w.btn_move,onClick:t,children:"Move"})]}),p.jsx("p",{className:w.p_info,children:"(Only zip file is supported now)"})]}),p.jsx("input",{ref:e,className:"hidden",type:"file",accept:".zip",onChange:s})]})},pe="_main_12bpp_1",de="_btn_download_12bpp_9",C={main:pe,btn_download:de},me=()=>{const{isLoading:l,hasGerber:e,setLink:s,ref:c,unzipFile:r,onDownloadImg:a}=K();return p.jsxs(p.Fragment,{children:[p.jsx("div",{className:C.main,ref:c,children:!e&&p.jsx(ee,{onClickExample:s,children:p.jsx(le,{unzipFile:r})})}),e&&p.jsx("button",{className:C.btn_download,onClick:a,children:"Download gerber image"})]})};S.createRoot(document.getElementById("root")).render(p.jsx(me,{}));
